import streamlit as st
import swisseph as swe
from datetime import datetime, time, timezone, timedelta
import os

# --- å®šæ•°ãƒ‡ãƒ¼ã‚¿ ---

# å¤©ä½“æš¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
EPHE_PATH = 'ephe'
# ã‚µã‚¤ãƒ³å
SIGN_NAMES = ["ç‰¡ç¾Šåº§", "ç‰¡ç‰›åº§", "åŒå­åº§", "èŸ¹åº§", "ç…å­åº§", "ä¹™å¥³åº§", "å¤©ç§¤åº§", "è åº§", "å°„æ‰‹åº§", "å±±ç¾Šåº§", "æ°´ç“¶åº§", "é­šåº§"]
# ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ
ELEMENTS = {'ç«': ["ç‰¡ç¾Šåº§", "ç…å­åº§", "å°„æ‰‹åº§"], 'åœ°': ["ç‰¡ç‰›åº§", "ä¹™å¥³åº§", "å±±ç¾Šåº§"], 'é¢¨': ["åŒå­åº§", "å¤©ç§¤åº§", "æ°´ç“¶åº§"], 'æ°´': ["èŸ¹åº§", "è åº§", "é­šåº§"]}
# ã‚¯ã‚ªãƒªãƒ†ã‚£
QUALITIES = {'æ´»å‹•': ["ç‰¡ç¾Šåº§", "èŸ¹åº§", "å¤©ç§¤åº§", "å±±ç¾Šåº§"], 'ä¸å‹•': ["ç‰¡ç‰›åº§", "ç…å­åº§", "è åº§", "æ°´ç“¶åº§"], 'æŸ”è»Ÿ': ["åŒå­åº§", "ä¹™å¥³åº§", "å°„æ‰‹åº§", "é­šåº§"]}
# å¤©ä½“ID
PLANET_IDS = {'å¤ªé™½': swe.SUN, 'æœˆ': swe.MOON, 'æ°´æ˜Ÿ': swe.MERCURY, 'é‡‘æ˜Ÿ': swe.VENUS, 'ç«æ˜Ÿ': swe.MARS, 'æœ¨æ˜Ÿ': swe.JUPITER, 'åœŸæ˜Ÿ': swe.SATURN, 'å¤©ç‹æ˜Ÿ': swe.URANUS, 'æµ·ç‹æ˜Ÿ': swe.NEPTUNE}

# éƒ½é“åºœçœŒã®ç·¯åº¦çµŒåº¦ãƒ‡ãƒ¼ã‚¿
PREFECTURE_DATA = {
    "åŒ—æµ·é“": {"lat": 43.064, "lon": 141.348}, "é’æ£®çœŒ": {"lat": 40.825, "lon": 140.741},
    "å²©æ‰‹çœŒ": {"lat": 39.704, "lon": 141.153}, "å®®åŸçœŒ": {"lat": 38.269, "lon": 140.872},
    "ç§‹ç”°çœŒ": {"lat": 39.719, "lon": 140.102}, "å±±å½¢çœŒ": {"lat": 38.240, "lon": 140.364},
    "ç¦å³¶çœŒ": {"lat": 37.750, "lon": 140.468}, "èŒ¨åŸçœŒ": {"lat": 36.342, "lon": 140.447},
    "æ ƒæœ¨çœŒ": {"lat": 36.566, "lon": 139.884}, "ç¾¤é¦¬çœŒ": {"lat": 36.391, "lon": 139.060},
    "åŸ¼ç‰çœŒ": {"lat": 35.857, "lon": 139.649}, "åƒè‘‰çœŒ": {"lat": 35.605, "lon": 140.123},
    "æ±äº¬éƒ½": {"lat": 35.690, "lon": 139.692}, "ç¥å¥ˆå·çœŒ": {"lat": 35.448, "lon": 139.643},
    "æ–°æ½ŸçœŒ": {"lat": 37.902, "lon": 139.023}, "å¯Œå±±çœŒ": {"lat": 36.695, "lon": 137.211},
    "çŸ³å·çœŒ": {"lat": 36.594, "lon": 136.626}, "ç¦äº•çœŒ": {"lat": 36.065, "lon": 136.222},
    "å±±æ¢¨çœŒ": {"lat": 35.664, "lon": 138.568}, "é•·é‡çœŒ": {"lat": 36.651, "lon": 138.181},
    "å²é˜œçœŒ": {"lat": 35.391, "lon": 136.722}, "é™å²¡çœŒ": {"lat": 34.977, "lon": 138.383},
    "æ„›çŸ¥çœŒ": {"lat": 35.180, "lon": 136.907}, "ä¸‰é‡çœŒ": {"lat": 34.730, "lon": 136.509},
    "æ»‹è³€çœŒ": {"lat": 35.005, "lon": 135.869}, "äº¬éƒ½åºœ": {"lat": 35.021, "lon": 135.756},
    "å¤§é˜ªåºœ": {"lat": 34.686, "lon": 135.520}, "å…µåº«çœŒ": {"lat": 34.691, "lon": 135.183},
    "å¥ˆè‰¯çœŒ": {"lat": 34.685, "lon": 135.833}, "å’Œæ­Œå±±çœŒ": {"lat": 34.226, "lon": 135.168},
    "é³¥å–çœŒ": {"lat": 35.504, "lon": 134.238}, "å³¶æ ¹çœŒ": {"lat": 35.472, "lon": 133.051},
    "å²¡å±±çœŒ": {"lat": 34.662, "lon": 133.934}, "åºƒå³¶çœŒ": {"lat": 34.396, "lon": 132.459},
    "å±±å£çœŒ": {"lat": 34.186, "lon": 131.471}, "å¾³å³¶çœŒ": {"lat": 34.066, "lon": 134.559},
    "é¦™å·çœŒ": {"lat": 34.340, "lon": 134.043}, "æ„›åª›çœŒ": {"lat": 33.842, "lon": 132.765},
    "é«˜çŸ¥çœŒ": {"lat": 33.560, "lon": 133.531}, "ç¦å²¡çœŒ": {"lat": 33.607, "lon": 130.418},
    "ä½è³€çœŒ": {"lat": 33.249, "lon": 130.299}, "é•·å´çœŒ": {"lat": 32.745, "lon": 129.874},
    "ç†Šæœ¬çœŒ": {"lat": 32.790, "lon": 130.742}, "å¤§åˆ†çœŒ": {"lat": 33.238, "lon": 131.613},
    "å®®å´çœŒ": {"lat": 31.911, "lon": 131.424}, "é¹¿å…å³¶çœŒ": {"lat": 31.560, "lon": 130.558},
    "æ²–ç¸„çœŒ": {"lat": 26.212, "lon": 127.681}
}

# å¿ƒç†ãƒ†ã‚¹ãƒˆã®è³ªå•ã¨é¸æŠè‚¢ã€ãŠã‚ˆã³å æ˜Ÿè¡“çš„ãƒãƒƒãƒ”ãƒ³ã‚°
QUESTIONS = [
    {
        "q": "è³ªå•1ï¼šæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹æ™‚ã€ã‚ãªãŸã®ã‚¹ã‚¿ã‚¤ãƒ«ã«æœ€ã‚‚è¿‘ã„ã®ã¯ï¼Ÿ",
        "a": {
            "a": "ã€Œã¾ãšã‚„ã£ã¦ã¿ã‚ˆã†ï¼ã€ã¨ã€ã™ãã«è¡Œå‹•ã‚’é–‹å§‹ã™ã‚‹ã€‚",
            "b": "æˆåŠŸã¾ã§ã®é“ã®ã‚Šã‚’è©³ç´°ã«è¨ˆç”»ã—ã€æº–å‚™ã‚’å›ºã‚ã¦ã‹ã‚‰å§‹ã‚ã‚‹ã€‚",
            "c": "å‘¨å›²ã®æ„è¦‹ã‚’èããªãŒã‚‰ã€æŸ”è»Ÿã«ã‚„ã‚Šæ–¹ã‚’å¤‰ãˆã¦ã„ãã€‚",
            "d": "ãªãœãã‚ŒãŒå¿…è¦ãªã®ã‹ã€ã¨ã„ã†ç†å¿µã‚„ç›®çš„ãŒæ˜ç¢ºã«ãªã‚‹ã¾ã§å‹•ã‹ãªã„ã€‚"
        },
        "map": {
            "a": {"type": "quality", "value": "æ´»å‹•", "target": "å…¨ä½“", "weight": 2, "reason": "å³æ–­å³æ±ºã®è¡Œå‹•åŠ›ã¯ã€Œæ´»å‹•å®®ã€ã®æ€§è³ªã§ã™ã€‚"},
            "b": {"type": "quality", "value": "ä¸å‹•", "target": "å…¨ä½“", "weight": 2, "reason": "æº–å‚™ã‚’å›ºã‚ã‚‹æŒç¶šåŠ›ã¯ã€Œä¸å‹•å®®ã€ã®æ€§è³ªã§ã™ã€‚"},
            "c": {"type": "quality", "value": "æŸ”è»Ÿ", "target": "å…¨ä½“", "weight": 2, "reason": "çŠ¶æ³ã«åˆã‚ã›ã‚‹å¯¾å¿œåŠ›ã¯ã€ŒæŸ”è»Ÿå®®ã€ã®æ€§è³ªã§ã™ã€‚"},
            "d": {"type": "emphasis", "value": "å¤ªé™½", "target": "å¤©ä½“", "weight": 1, "reason": "ç†å¿µã‚„ç›®çš„æ„è­˜ã¯ã€Œå¤ªé™½ã€ãŒè±¡å¾´ã—ã¾ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•2ï¼šå¤§ããªå•é¡Œã«ç›´é¢ã—ãŸæ™‚ã€æœ€åˆã«ã¨ã‚‹è¡Œå‹•ã¯ï¼Ÿ",
        "a": {
            "a": "ä¿¡é ¼ã§ãã‚‹å‹äººæ•°äººã«ç›¸è«‡ã—ã€æ„è¦‹ã‚’æ±‚ã‚ã‚‹ã€‚",
            "b": "èª°ã«ã‚‚è©±ã•ãšã€ä¸€äººã§ã˜ã£ãã‚Šã¨è€ƒãˆã€è§£æ±ºç­–ã‚’æ¢ã™ã€‚",
            "c": "æ„Ÿæƒ…çš„ã«ãªã‚Šã€ã¾ãšã¯ãã®æ°—æŒã¡ã‚’èª°ã‹ã«èã„ã¦ã‚‚ã‚‰ã„ãŸããªã‚‹ã€‚",
            "d": "å•é¡Œã‹ã‚‰ä¸€æ—¦é›¢ã‚Œã€è¶£å‘³ã‚„åˆ¥ã®ä½œæ¥­ã«æ²¡é ­ã—ã¦æ°—åˆ†è»¢æ›ã™ã‚‹ã€‚"
        },
        "map": {
            "a": {"type": "element", "value": "é¢¨", "target": "æœˆ", "weight": 3, "reason": "å®¢è¦³çš„ãªæ„è¦‹ã‚’æ±‚ã‚ã‚‹å‚¾å‘ã¯ã€Œé¢¨ã®æœˆã€ã§ã™ã€‚"},
            "b": {"type": "element", "value": "åœ°", "target": "æœˆ", "weight": 3, "reason": "ç¾å®Ÿçš„ãªè§£æ±ºç­–ã‚’ä¸€äººã§æ¢ã™ã®ã¯ã€Œåœ°ã®æœˆã€ã§ã™ã€‚"},
            "c": {"type": "element", "value": "æ°´", "target": "æœˆ", "weight": 3, "reason": "æ„Ÿæƒ…ã®å…±æœ‰ã‚’æ±‚ã‚ã‚‹ã®ã¯ã€Œæ°´ã®æœˆã€ã§ã™ã€‚"},
            "d": {"type": "element", "value": "ç«", "target": "æœˆ", "weight": 3, "reason": "è¡Œå‹•ã§æ°—åˆ†è»¢æ›ã™ã‚‹ã®ã¯ã€Œç«ã®æœˆã€ã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•3ï¼šç†æƒ³çš„ãªä¼‘æ—¥ã®éã”ã—æ–¹ã¯ï¼Ÿ",
        "a": {
            "a": "å¤§å‹¢ã®å‹äººã¨é›†ã¾ã‚Šã€è³‘ã‚„ã‹ã«ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¥½ã—ã‚€ã€‚",
            "b": "ã”ãè¦ªã—ã„å‹äººã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã€äºŒäººãã‚Šã§æ·±ã„èªã‚‰ã„ã‚’ã™ã‚‹ã€‚",
            "c": "ä¸€äººã§è¶£å‘³ã«æ²¡é ­ã—ãŸã‚Šã€å®¶ã§ã‚†ã£ãã‚Šã¨éã”ã—ãŸã‚Šã™ã‚‹ã€‚",
            "d": "æ–°ã—ã„å ´æ‰€ã¸å‡ºã‹ã‘ãŸã‚Šã€ã‚»ãƒŸãƒŠãƒ¼ã«å‚åŠ ã—ãŸã‚Šã—ã¦çŸ¥çš„ãªåˆºæ¿€ã‚’æ±‚ã‚ã‚‹ã€‚"
        },
        "map": {
            "a": {"type": "element", "value": "ç«", "target": "ASC", "weight": 2, "reason": "å¤–å‘çš„ã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªä¼‘æ—¥ã¯ã€Œç«ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€ã‚„ã€ŒASCã€ã®æ€§è³ªã§ã™ã€‚"},
            "b": {"type": "sign_emphasis", "value": "è åº§", "target": "ASC", "weight": 2, "reason": "æ·±ãå¯†ãªé–¢ä¿‚ã‚’å¥½ã‚€ã®ã¯ã€Œæ°´ã®ã‚µã‚¤ãƒ³ã€ã€ç‰¹ã«ã€Œè åº§ã€ã®æ€§è³ªã§ã™ã€‚"},
            "c": {"type": "element", "value": "åœ°", "target": "ASC", "weight": 2, "reason": "è½ã¡ç€ã„ãŸä¸€äººã®æ™‚é–“ã¯ã€Œåœ°ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€ã‚„ã€ŒASCã€ã®æ€§è³ªã§ã™ã€‚"},
            "d": {"type": "sign_emphasis", "value": "å°„æ‰‹åº§", "target": "ASC", "weight": 2, "reason": "çŸ¥çš„ãªæ¢æ±‚ã¯ã€Œé¢¨ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€ã‚„ã€Œå°„æ‰‹åº§ã€ã®æ€§è³ªã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•4ï¼šäººç”Ÿã®å¤§ããªæ±ºæ–­ã‚’ã™ã‚‹æ™‚ã€æœ€çµ‚çš„ãªæ±ºã‚æ‰‹ã¯ï¼Ÿ",
        "a": {
            "a": "è«–ç†çš„ãªãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ¯”è¼ƒæ¤œè¨ã—ãŸä¸Šã§ã®çµè«–ã€‚",
            "b": "ã€Œãªã‚“ã¨ãªãã“ã¡ã‚‰ã®æ–¹ãŒè‰¯ã„æ°—ãŒã™ã‚‹ã€ã¨ã„ã†ç›´æ„Ÿã‚„ãƒ•ã‚£ãƒ¼ãƒªãƒ³ã‚°ã€‚",
            "c": "å°†æ¥ã®å®‰å®šã‚„çµŒæ¸ˆçš„ãªå®‰å¿ƒæ„ŸãŒå¾—ã‚‰ã‚Œã‚‹ã‹ã©ã†ã‹ã€‚",
            "d": "è‡ªåˆ†ã®ç†æƒ³ã‚„ã€Œã“ã†ã‚ã‚ŠãŸã„ã€ã¨ã„ã†å¤¢ã«è¿‘ã¥ã‘ã‚‹ã‹ã©ã†ã‹ã€‚"
        },
        "map": {
            "a": {"type": "emphasis", "value": "æ°´æ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "è«–ç†çš„ãªåˆ¤æ–­ã¯ã€Œæ°´æ˜Ÿã€ãŒè±¡å¾´ã—ã¾ã™ã€‚"},
            "b": {"type": "emphasis", "value": "æœˆ", "target": "å¤©ä½“", "weight": 2, "reason": "ç›´æ„Ÿã‚„æ„Ÿæƒ…ã¯ã€Œæœˆã€ãŒè±¡å¾´ã—ã¾ã™ã€‚"},
            "c": {"type": "emphasis", "value": "åœŸæ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "å®‰å®šã‚„ç¾å®Ÿã¯ã€ŒåœŸæ˜Ÿã€ãŒè±¡å¾´ã—ã¾ã™ã€‚"},
            "d": {"type": "emphasis", "value": "æµ·ç‹æ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "ç†æƒ³ã‚„å¤¢ã¯ã€Œæµ·ç‹æ˜Ÿã€ãŒè±¡å¾´ã—ã¾ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•5ï¼šã‚ãªãŸãŒæœ€ã‚‚ã€Œè¨±ã›ãªã„ã€ã¨æ„Ÿã˜ã‚‹ã“ã¨ã¯ï¼Ÿ",
        "a": {
            "a": "è£åˆ‡ã‚‰ã‚Œã‚‹ã“ã¨ã€ç§˜å¯†ã‚’è»½ã€…ã—ãæ‰±ã‚ã‚Œã‚‹ã“ã¨ã€‚",
            "b": "ä¸èª å®Ÿãªæ…‹åº¦ã€ãã®å ´ã—ã®ãã®å˜˜ã‚’ã¤ã‹ã‚Œã‚‹ã“ã¨ã€‚",
            "c": "å„ªæŸ”ä¸æ–­ãªæ…‹åº¦ã§ã€ç‰©äº‹ã‚’ãªã‹ãªã‹æ±ºã‚ãªã„ã“ã¨ã€‚",
            "d": "éåŠ¹ç‡ã§ã€ç„¡é§„ãŒå¤šã„ã‚„ã‚Šæ–¹ã‚’å¼·è¦ã•ã‚Œã‚‹ã“ã¨ã€‚"
        },
        "map": {
            "a": {"type": "sign_emphasis", "value": "è åº§", "target": "å¤ªé™½/æœˆ/ASC", "weight": 3, "reason": "è£åˆ‡ã‚Šã¸ã®å¼·ã„åç™ºã¯ã€Œè åº§ã€ã®ä¾¡å€¤è¦³ã§ã™ã€‚"},
            "b": {"type": "sign_emphasis", "value": "å±±ç¾Šåº§", "target": "å¤ªé™½/æœˆ/ASC", "weight": 3, "reason": "èª å®Ÿã•ã‚’é‡ã‚“ã˜ã‚‹ã®ã¯ã€Œå±±ç¾Šåº§ã€ã®ä¾¡å€¤è¦³ã§ã™ã€‚"},
            "c": {"type": "sign_emphasis", "value": "ç‰¡ç¾Šåº§", "target": "å¤ªé™½/æœˆ/ASC", "weight": 3, "reason": "æ±ºæ–­ã®é€Ÿã•ã‚’æ±‚ã‚ã‚‹ã®ã¯ã€Œç‰¡ç¾Šåº§ã€ã®ä¾¡å€¤è¦³ã§ã™ã€‚"},
            "d": {"type": "sign_emphasis", "value": "ä¹™å¥³åº§", "target": "å¤ªé™½/æœˆ/ASC", "weight": 3, "reason": "åŠ¹ç‡æ€§ã‚’é‡è¦–ã™ã‚‹ã®ã¯ã€Œä¹™å¥³åº§ã€ã®ä¾¡å€¤è¦³ã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•6ï¼šä»–äººã¨ã®æ„è¦‹å¯¾ç«‹ãŒèµ·ããŸæ™‚ã€ã‚ãªãŸã®æ…‹åº¦ã¯ï¼Ÿ",
        "a": {
            "a": "è‡ªåˆ†ã®æ­£ã—ã•ã‚’ä¸»å¼µã—ã€ç›¸æ‰‹ã‚’èª¬å¾—ã—ã‚ˆã†ã¨è©¦ã¿ã‚‹ã€‚",
            "b": "ãã®å ´ã®èª¿å’Œã‚’å„ªå…ˆã—ã€è‡ªåˆ†ã®æ„è¦‹ã‚’ä¸€æ—¦æŠ‘ãˆã‚‹ã€‚",
            "c": "å†·é™ã«è­°è«–ã—ã€ãŠäº’ã„ã®å¦¥å”ç‚¹ã‚’æ¢ã‚‹ã€‚",
            "d": "æ„Ÿæƒ…çš„ã«ãªã‚Šã€ãã®å ´ã‹ã‚‰é›¢ã‚ŒãŸããªã‚‹ã€‚"
        },
        "map": {
            "a": {"type": "element", "value": "ç«", "target": "ç«æ˜Ÿ", "weight": 2, "reason": "è‡ªå·±ä¸»å¼µã®å¼·ã•ã¯ã€Œç«ã®ç«æ˜Ÿã€ã§ã™ã€‚"},
            "b": {"type": "sign_emphasis", "value": "å¤©ç§¤åº§", "target": "ç«æ˜Ÿ", "weight": 2, "reason": "èª¿å’Œã‚’å„ªå…ˆã™ã‚‹ã®ã¯ã€Œå¤©ç§¤åº§ã€ã®æ€§è³ªã§ã™ã€‚"},
            "c": {"type": "element", "value": "é¢¨", "target": "ç«æ˜Ÿ", "weight": 2, "reason": "å†·é™ãªè­°è«–ã‚’å¥½ã‚€ã®ã¯ã€Œé¢¨ã®ç«æ˜Ÿã€ã§ã™ã€‚"},
            "d": {"type": "element", "value": "æ°´", "target": "ç«æ˜Ÿ", "weight": 2, "reason": "æ„Ÿæƒ…çš„ã«ãªã‚Šã‚„ã™ã„ã®ã¯ã€Œæ°´ã®ç«æ˜Ÿã€ã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•7ï¼šã‚ãªãŸã«ã¨ã£ã¦ã€Œç¾ã—ã•ã€ã¨ã¯ï¼Ÿ",
        "a": {
            "a": "æ©Ÿèƒ½çš„ã§æ´—ç·´ã•ã‚ŒãŸã€ç„¡é§„ã®ãªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚",
            "b": "è‡ªç„¶ã®ç´ æã‚„ã€æ‰‹ä»•äº‹ã®æ¸©ã‹ã¿ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚‚ã®ã€‚",
            "c": "è¯ã‚„ã‹ã§ã€äººã®å¿ƒã‚’é«˜æšã•ã›ã‚‹ãƒ‰ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªã‚‚ã®ã€‚",
            "d": "å„šã•ã‚„ã€ä¸å®Œå…¨ã•ã®ä¸­ã«å®¿ã‚‹è¶£ã€‚"
        },
        "map": {
            "a": {"type": "sign_emphasis", "value": "ä¹™å¥³åº§", "target": "é‡‘æ˜Ÿ", "weight": 2, "reason": "æ©Ÿèƒ½ç¾ã¯ã€Œä¹™å¥³åº§ã€ã‚„ã€Œæ°´ç“¶åº§ã€ã®é‡‘æ˜Ÿã§ã™ã€‚"},
            "b": {"type": "sign_emphasis", "value": "ç‰¡ç‰›åº§", "target": "é‡‘æ˜Ÿ", "weight": 2, "reason": "äº”æ„Ÿã«è¨´ãˆã‚‹è‡ªç„¶ç¾ã¯ã€Œç‰¡ç‰›åº§ã€ã®é‡‘æ˜Ÿã§ã™ã€‚"},
            "c": {"type": "sign_emphasis", "value": "ç…å­åº§", "target": "é‡‘æ˜Ÿ", "weight": 2, "reason": "ãƒ‰ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªç¾ã¯ã€Œç…å­åº§ã€ã®é‡‘æ˜Ÿã§ã™ã€‚"},
            "d": {"type": "sign_emphasis", "value": "é­šåº§", "target": "é‡‘æ˜Ÿ", "weight": 2, "reason": "å„šã•ã®ç¾å­¦ã¯ã€Œé­šåº§ã€ã®é‡‘æ˜Ÿã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•8ï¼šä»•äº‹ã«ãŠã„ã¦ã€æœ€ã‚‚ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã‚‹ç¬é–“ã¯ï¼Ÿ",
        "a": {
            "a": "ãƒãƒ¼ãƒ ã§ä¸€ä½“ã¨ãªã‚Šã€å¤§ããªç›®æ¨™ã‚’é”æˆã—ãŸæ™‚ã€‚",
            "b": "è‡ªåˆ†ã®å°‚é–€ã‚¹ã‚­ãƒ«ã‚„çŸ¥è­˜ã‚’æ·±ã‚ã€å®Œç’§ãªä»•äº‹ãŒã§ããŸæ™‚ã€‚",
            "c": "èª°ã‹ã®å½¹ã«ç«‹ã£ã¦ã„ã‚‹ã€ç¤¾ä¼šã«è²¢çŒ®ã—ã¦ã„ã‚‹ã¨å®Ÿæ„Ÿã—ãŸæ™‚ã€‚",
            "d": "é«˜ã„è©•ä¾¡ã‚’å¾—ã¦ã€è‡ªåˆ†ã®åœ°ä½ã‚„åå…¥ãŒä¸ŠãŒã£ãŸæ™‚ã€‚"
        },
        "map": {
            "a": {"type": "house_emphasis", "value": 11, "target": "MC", "weight": 2, "reason": "ãƒãƒ¼ãƒ ã§ã®é”æˆã¯ã€Œ11ãƒã‚¦ã‚¹ã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "b": {"type": "sign_emphasis", "value": "ä¹™å¥³åº§", "target": "MC", "weight": 2, "reason": "å®Œç’§ãªã‚¹ã‚­ãƒ«ã¯ã€Œä¹™å¥³åº§ã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "c": {"type": "sign_emphasis", "value": "é­šåº§", "target": "MC", "weight": 2, "reason": "ç¤¾ä¼šã¸ã®è²¢çŒ®ã¯ã€Œé­šåº§ã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "d": {"type": "sign_emphasis", "value": "å±±ç¾Šåº§", "target": "MC", "weight": 2, "reason": "ç¤¾ä¼šçš„åœ°ä½ã¯ã€Œå±±ç¾Šåº§ã€ã‚„ã€Œ10ãƒã‚¦ã‚¹ã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•9ï¼šã‚ãªãŸã®äººç”Ÿè¦³ã«æœ€ã‚‚è¿‘ã„è€ƒãˆæ–¹ã¯ï¼Ÿ",
        "a": {
            "a": "äººç”Ÿã¯ä¸€åº¦ãã‚Šã€‚å¸¸ã«æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ã€è‡ªåˆ†ã‚’æˆé•·ã•ã›ãŸã„ã€‚",
            "b": "é‹å‘½ã‚„è¦‹ãˆãªã„åŠ›ã¯å­˜åœ¨ã™ã‚‹ã€‚æµã‚Œã«èº«ã‚’ä»»ã›ã‚‹ã“ã¨ã‚‚å¤§åˆ‡ã ã€‚",
            "c": "åŠªåŠ›ã¯å¿…ãšå ±ã‚ã‚Œã‚‹ã€‚åœ°é“ãªç©ã¿é‡ã­ãŒç¢ºã‹ãªæœªæ¥ã‚’å‰µã‚‹ã€‚",
            "d": "äººç”Ÿã¯æ¥½ã—ã‚€ãŸã‚ã«ã‚ã‚‹ã€‚ãƒ¦ãƒ¼ãƒ¢ã‚¢ã¨æ¥½è¦³æ€§ã‚’å¿˜ã‚ŒãŸããªã„ã€‚"
        },
        "map": {
            "a": {"type": "emphasis", "value": "æœ¨æ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "æˆé•·ã¨æŒ‘æˆ¦ã¯ã€Œæœ¨æ˜Ÿã€ã‚„ã€Œç«ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "b": {"type": "emphasis", "value": "æµ·ç‹æ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "é‹å‘½è«–ã¯ã€Œæµ·ç‹æ˜Ÿã€ã‚„ã€Œ12ãƒã‚¦ã‚¹ã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "c": {"type": "emphasis", "value": "åœŸæ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "åŠªåŠ›ã¨ç¾å®Ÿä¸»ç¾©ã¯ã€ŒåœŸæ˜Ÿã€ã‚„ã€Œåœ°ã®ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"},
            "d": {"type": "sign_emphasis", "value": "å°„æ‰‹åº§", "target": "å…¨ä½“", "weight": 2, "reason": "æ¥½è¦³æ€§ã¯ã€Œå°„æ‰‹åº§ã€ã‚„ã€Œæœ¨æ˜Ÿã€ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚"}
        }
    },
    {
        "q": "è³ªå•10ï¼šå¤§ããªå¤±æ•—ã‚’ã—ãŸæ™‚ã€ã©ã†ä¹—ã‚Šè¶Šãˆã¾ã™ã‹ï¼Ÿ",
        "a": {
            "a": "è‡ªåˆ†ã®åŠ›ä¸è¶³ã‚’ç—›æ„Ÿã—ã€åŸå› ã‚’å¾¹åº•çš„ã«åˆ†æã—ã¦æ¬¡ã«æ´»ã‹ã™ã€‚",
            "b": "ä¿¡é ¼ã§ãã‚‹äººã«è©±ã‚’èã„ã¦ã‚‚ã‚‰ã„ã€åŠ±ã¾ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã§ç«‹ã¡ç›´ã‚‹ã€‚",
            "c": "ã€Œã“ã‚Œã‚‚çµŒé¨“ã ã€ã¨æ°—æŒã¡ã‚’åˆ‡ã‚Šæ›¿ãˆã€ã‚ã¾ã‚Šå¼•ããšã‚‰ãªã„ã€‚",
            "d": "ã—ã°ã‚‰ãè½ã¡è¾¼ã‚€ãŒã€æ™‚é–“ãŒçµŒã¦ã°è‡ªç„¶ã¨å¿˜ã‚Œã¦ã„ãã€‚"
        },
        "map": {
            "a": {"type": "emphasis", "value": "åœŸæ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "åŸå› åˆ†æã¨åçœã¯ã€ŒåœŸæ˜Ÿã€ã®æ€§è³ªã§ã™ã€‚"},
            "b": {"type": "emphasis", "value": "æœˆ", "target": "å¤©ä½“", "weight": 2, "reason": "å…±æ„Ÿã«ã‚ˆã‚‹å›å¾©ã¯ã€Œæœˆã€ã®æ€§è³ªã§ã™ã€‚"},
            "c": {"type": "emphasis", "value": "æœ¨æ˜Ÿ", "target": "å¤©ä½“", "weight": 2, "reason": "æ¥½è¦³çš„ãªåˆ‡ã‚Šæ›¿ãˆã¯ã€Œæœ¨æ˜Ÿã€ã®æ€§è³ªã§ã™ã€‚"},
            "d": {"type": "quality", "value": "æŸ”è»Ÿ", "target": "å…¨ä½“", "weight": 2, "reason": "è‡ªç„¶ãªå¿˜å´ã¯ã€ŒæŸ”è»Ÿå®®ã€ã®æ€§è³ªã§ã™ã€‚"}
        }
    },
    # â–¼â–¼â–¼ å¤‰æ›´ç‚¹1ï¼šæ–°ã—ã„è³ªå•ã‚’è¿½åŠ  â–¼â–¼â–¼
    {
        "q": "è³ªå•11ï¼šã‚ãªãŸã®ä½“å‹ã‚„ç¬¬ä¸€å°è±¡ã«ã¤ã„ã¦ã€äººã‹ã‚‰ã‚ˆãè¨€ã‚ã‚Œã‚‹ã“ã¨ã«æœ€ã‚‚è¿‘ã„ã‚‚ã®ã¯ï¼Ÿ",
        "a": {
            "a": "ã‚¹ãƒ©ãƒªã¨ã—ã¦ä¸­æ€§çš„ã€ã‚·ãƒ£ãƒ¼ãƒ—ãªå°è±¡",
            "b": "ãŒã£ã—ã‚Šã—ã¦ã„ã¦ã€è½ã¡ç€ã„ãŸå°è±¡",
            "c": "ãµã£ãã‚‰ã¨ã—ã¦ã€å„ªã—ãè¦ªã—ã¿ã‚„ã™ã„å°è±¡",
            "d": "ç­‹è‚‰è³ªã§ã€ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªå°è±¡"
        },
        "map": {
            "a": {"type": "multi_sign_emphasis", "value": ["åŒå­åº§", "ä¹™å¥³åº§", "æ°´ç“¶åº§"], "target": "ASC", "weight": 3, "reason": "èº«ä½“çš„ç‰¹å¾´ã‹ã‚‰ã€ä¸­æ€§çš„ãªå°è±¡ã‚’ä¸ãˆã‚‹ã€Œé¢¨ã®ã‚µã‚¤ãƒ³ã€ã‚„ã€Œä¹™å¥³åº§ã€ã®ASCã®å¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã¾ã™ã€‚"},
            "b": {"type": "multi_sign_emphasis", "value": ["ç‰¡ç‰›åº§", "å±±ç¾Šåº§"], "target": "ASC", "weight": 3, "reason": "èº«ä½“çš„ç‰¹å¾´ã‹ã‚‰ã€è½ã¡ç€ã„ãŸå°è±¡ã‚’ä¸ãˆã‚‹ã€Œåœ°ã®ã‚µã‚¤ãƒ³ã€ã®ASCã®å¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã¾ã™ã€‚"},
            "c": {"type": "multi_sign_emphasis", "value": ["èŸ¹åº§", "é­šåº§"], "target": "ASC", "weight": 3, "reason": "èº«ä½“çš„ç‰¹å¾´ã‹ã‚‰ã€è¦ªã—ã¿ã‚„ã™ã„å°è±¡ã‚’ä¸ãˆã‚‹ã€Œæ°´ã®ã‚µã‚¤ãƒ³ã€ã®ASCã®å¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã¾ã™ã€‚"},
            "d": {"type": "multi_sign_emphasis", "value": ["ç‰¡ç¾Šåº§", "ç…å­åº§"], "target": "ASC", "weight": 3, "reason": "èº«ä½“çš„ç‰¹å¾´ã‹ã‚‰ã€ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªå°è±¡ã‚’ä¸ãˆã‚‹ã€Œç«ã®ã‚µã‚¤ãƒ³ã€ã®ASCã®å¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã¾ã™ã€‚"}
        }
    }
]


# --- å æ˜Ÿè¡“è¨ˆç®—é–¢æ•° ---

def get_jd(dt_obj):
    """datetimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ¦ãƒªã‚¦ã‚¹æ—¥ã‚’è¨ˆç®—"""
    dt_utc = dt_obj.replace(tzinfo=timezone(timedelta(hours=9))).astimezone(timezone.utc)
    return swe.utc_to_jd(dt_utc.year, dt_utc.month, dt_utc.day, dt_utc.hour, dt_utc.minute, dt_utc.second, 1)[1]

def get_sign(degree):
    """åº¦æ•°ã‹ã‚‰ã‚µã‚¤ãƒ³åã‚’å–å¾—"""
    return SIGN_NAMES[int(degree / 30)]

def calculate_chart(jd, lat, lon):
    """æŒ‡å®šã•ã‚ŒãŸæ—¥æ™‚ã®ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—"""
    chart = {'planets': {}, 'angles': {}, 'elements': {'ç«': 0, 'åœ°': 0, 'é¢¨': 0, 'æ°´': 0}, 'qualities': {'æ´»å‹•': 0, 'ä¸å‹•': 0, 'æŸ”è»Ÿ': 0}}
    iflag = swe.FLG_SWIEPH
    
    # å¤©ä½“
    for name, pid in PLANET_IDS.items():
        pos = swe.calc_ut(jd, pid, iflag)[0][0]
        sign = get_sign(pos)
        chart['planets'][name] = sign
        for el, signs in ELEMENTS.items():
            if sign in signs: chart['elements'][el] += 1
        for q, signs in QUALITIES.items():
            if sign in signs: chart['qualities'][q] += 1
            
    # ã‚¢ãƒ³ã‚°ãƒ«
    cusps, ascmc = swe.houses(jd, lat, lon, b'P')
    chart['angles']['ASC'] = get_sign(ascmc[0])
    chart['angles']['MC'] = get_sign(ascmc[1])
    
    return chart

def score_chart(chart, answers):
    """å¿ƒç†ãƒ†ã‚¹ãƒˆã®å›ç­”ã¨ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã®ä¸€è‡´åº¦ã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°"""
    score = 0
    reasons = []

    for i, ans_key in enumerate(answers):
        if not ans_key: continue
        
        q_map = QUESTIONS[i]["map"][ans_key]
        map_type = q_map["type"]
        map_value = q_map["value"]
        map_target = q_map["target"]
        map_weight = q_map["weight"]
        map_reason = f"è³ªå•{i+1}ã®å›ç­”ã‹ã‚‰ã€{q_map['reason']}"

        is_match = False
        
        if map_type == "quality":
            if chart['qualities'][map_value] >= 4:
                is_match = True
        elif map_type == "element":
            if map_target == "æœˆ" and chart['planets']['æœˆ'] in ELEMENTS[map_value]: is_match = True
            elif map_target == "ASC" and chart['angles']['ASC'] in ELEMENTS[map_value]: is_match = True
            elif map_target == "ç«æ˜Ÿ" and chart['planets']['ç«æ˜Ÿ'] in ELEMENTS[map_value]: is_match = True
        elif map_type == "sign_emphasis":
            if "å¤ªé™½" in map_target and chart['planets']['å¤ªé™½'] == map_value: is_match = True
            if "æœˆ" in map_target and chart['planets']['æœˆ'] == map_value: is_match = True
            if "ASC" in map_target and chart['angles']['ASC'] == map_value: is_match = True
            if "MC" in map_target and chart['angles']['MC'] == map_value: is_match = True
            if "é‡‘æ˜Ÿ" in map_target and chart['planets']['é‡‘æ˜Ÿ'] == map_value: is_match = True
            if "ç«æ˜Ÿ" in map_target and chart['planets']['ç«æ˜Ÿ'] == map_value: is_match = True
            if "å…¨ä½“" in map_target and (chart['angles']['ASC'] == map_value or chart['planets']['å¤ªé™½'] == map_value): is_match = True
        
        # â–¼â–¼â–¼ å¤‰æ›´ç‚¹2ï¼šæ–°ã—ã„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ  â–¼â–¼â–¼
        elif map_type == "multi_sign_emphasis":
            if map_target == "ASC" and chart['angles']['ASC'] in map_value:
                is_match = True

        elif map_type == "emphasis":
             if chart['planets'].get(map_value):
                score += map_weight / 2
                reasons.append(f"{map_reason}ï¼ˆ{map_value}ã®å­˜åœ¨ï¼‰")
        elif map_type == "house_emphasis":
            if chart['angles']['MC'] in SIGN_NAMES:
                 score += map_weight / 2
                 reasons.append(f"{map_reason}ï¼ˆMCã®å­˜åœ¨ï¼‰")

        if is_match:
            score += map_weight
            reasons.append(map_reason)
            
    return score, reasons

# --- Streamlit UI ---

st.set_page_config(page_title="å¿ƒç†å æ˜Ÿè¡“ãƒ¬ã‚¯ãƒ†ã‚£ãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", page_icon="ğŸ”®")
st.title("ğŸ”® å¿ƒç†å æ˜Ÿè¡“ãƒ¬ã‚¯ãƒ†ã‚£ãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³")
st.write("11ã®è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®æ€§æ ¼ã‹ã‚‰æœ€ã‚‚å¯èƒ½æ€§ã®é«˜ã„å‡ºç”Ÿæ™‚åˆ»ã‚’æ¨å®šã—ã¾ã™ã€‚")

# --- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ---
st.header("1. åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
col1, col2 = st.columns(2)
birth_date = col1.date_input("ğŸ“… ç”Ÿå¹´æœˆæ—¥", min_value=datetime(1900, 1, 1), max_value=datetime(2099, 12, 31), value=datetime(1990, 1, 1))
birth_pref = col2.selectbox("ğŸ“ å‡ºç”Ÿéƒ½é“åºœçœŒ", options=list(PREFECTURE_DATA.keys()), index=12)

st.header("2. å¿ƒç†ãƒ†ã‚¹ãƒˆ")
st.info("æ·±ãè€ƒãˆãšã€ç›´æ„Ÿçš„ã«ãŠç­”ãˆãã ã•ã„ã€‚")

answers = []
for i, q_data in enumerate(QUESTIONS):
    st.subheader(q_data["q"])
    ans = st.radio("é¸æŠè‚¢:", list(q_data["a"].values()), key=f"q{i}", index=None, horizontal=True)
    ans_key = next((key for key, value in q_data["a"].items() if value == ans), None)
    answers.append(ans_key)

st.markdown("---")

# --- å®Ÿè¡Œãƒœã‚¿ãƒ³ ---
if st.button("é‘‘å®šã™ã‚‹ ğŸš€", type="primary"):
    if None in answers:
        st.warning("ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚")
    else:
        # --- è¨ˆç®—å‡¦ç† ---
        if not os.path.exists(EPHE_PATH):
            st.error(f"å¤©ä½“æš¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`{EPHE_PATH}` ãƒ•ã‚©ãƒ«ãƒ€ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚")
            st.stop()
        swe.set_ephe_path(EPHE_PATH)

        coords = PREFECTURE_DATA[birth_pref]
        lat, lon = coords["lat"], coords["lon"]
        
        candidate_times = []
        
        progress_text = "å‡ºç”Ÿæ™‚åˆ»ã®å€™è£œã‚’æ¤œè¨¼ä¸­... (00:00)"
        bar = st.progress(0, text=progress_text)

        # 15åˆ†é–“éš”ã§æ™‚åˆ»ã‚’æ¤œè¨¼
        total_steps = 24 * 4
        for i, minute_of_day in enumerate(range(0, 24 * 60, 15)):
            hour = minute_of_day // 60
            minute = minute_of_day % 60
            candidate_time = time(hour, minute)
            
            bar.progress((i + 1) / total_steps, text=f"å‡ºç”Ÿæ™‚åˆ»ã®å€™è£œã‚’æ¤œè¨¼ä¸­... ({candidate_time.strftime('%H:%M')})")
            
            birth_dt = datetime.combine(birth_date, candidate_time)
            jd = get_jd(birth_dt)
            
            chart = calculate_chart(jd, lat, lon)
            score, reasons = score_chart(chart, answers)
            
            if score > 0:
                candidate_times.append({"time": candidate_time, "score": score, "reasons": reasons})

        bar.empty()

        # --- çµæœè¡¨ç¤º ---
        st.header("é‘‘å®šçµæœ")
        if not candidate_times:
            st.warning("å›ç­”ã«ä¸€è‡´ã™ã‚‹æœ‰åŠ›ãªå‡ºç”Ÿæ™‚åˆ»ã®å€™è£œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        else:
            sorted_candidates = sorted(candidate_times, key=lambda x: x['score'], reverse=True)
            max_score = sorted_candidates[0]['score']
            
            st.success(f"ã‚ãªãŸã®æ€§æ ¼ã«æœ€ã‚‚ä¸€è‡´ã™ã‚‹å¯èƒ½æ€§ã®é«˜ã„å‡ºç”Ÿæ™‚åˆ»ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚")

            for i, candidate in enumerate(sorted_candidates[:5]):
                percentage = (candidate['score'] / max_score * 100) if max_score > 0 else 0
                
                with st.container(border=True):
                    st.subheader(f"ç¬¬ {i+1} ä½ï¼š **{candidate['time'].strftime('%H:%M')} ã”ã‚**")
                    st.progress(int(percentage), text=f"å¯èƒ½æ€§: {percentage:.1f}%")
                    
                    st.markdown("**â–¼ è¥¿æ´‹å æ˜Ÿè¡“ã®è¦³ç‚¹ã‹ã‚‰ã®æ ¹æ‹ **")
                    unique_reasons = sorted(list(set(candidate['reasons'])))
                    for reason in unique_reasons:
                        st.markdown(f"- {reason}")
